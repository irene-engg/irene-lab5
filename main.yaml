version: 0.2

env:
  variables:
    GCP_PROJECT_ID: "angular-land-438802-e4"
    IMAGE_NAME: "irene-app"
    IMAGE_TAG: "latest"

phases:
  install:
    runtime-versions:
      docker: 20
    commands:
      - echo "Installing Google Cloud SDK..."
      - curl -sSL https://sdk.cloud.google.com | bash
      - exec -l $SHELL
      - gcloud components install docker

  pre_build:
    commands:
      - echo "Authenticating with Google Cloud..."
      - gcloud auth activate-service-account --key-file=gcp-service-account.json
      - gcloud config set project $GCP_PROJECT_ID
      - gcloud auth configure-docker

  build:
    commands:
      - echo "Building the Docker image..."
      - docker build -t gcr.io/$GCP_PROJECT_ID/$IMAGE_NAME:$IMAGE_TAG .

  post_build:
    commands:
      - echo "Pushing the Docker image to GCR..."
      - docker push gcr.io/$GCP_PROJECT_ID/$IMAGE_NAME:$IMAGE_TAG
      - echo "Creating imagedefinitions.json..."
      - |
        echo '[ 
          { 
            "name": "irene-app", 
            "imageUri": "gcr.io/'$GCP_PROJECT_ID'/'$IMAGE_NAME':'$IMAGE_TAG'" 
          } 
        ]' > imagedefinitions.json

artifacts:
  files:
    - imagedefinitions.json
